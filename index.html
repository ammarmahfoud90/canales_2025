<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <title>Visor de Canales 2025</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <style>
    html, body, #map { height:100%; margin:0; padding:0 }
    .info-card {
      position:absolute; top:10px; right:10px; z-index:1000;
      background:rgba(255,255,255,0.95); padding:12px 16px;
      width:260px; border-radius:6px; box-shadow:0 0 8px rgba(0,0,0,0.3);
      font:16px sans-serif; line-height:1.4;
    }
    .center-button {
      background:white; border:none; padding:6px; border-radius:4px;
      box-shadow:0 0 5px rgba(0,0,0,0.3); cursor:pointer;
    }
    /* Control de Capas Unificado */
    .leaflet-control-layers {
      background: rgba(255,255,255,0.95);
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      font:14px sans-serif; max-width:200px;
    }
    .leaflet-control-layers label {
      display:flex; align-items:center; margin-bottom:4px;
    }
    .leaflet-control-layers i {
      display:inline-block; width:18px; height:3px; margin:0 6px 0 3px;
    }
  </style>
</head>
<body>

  <!-- Cartela institucional -->
  <div class="info-card">
    <strong>Administraci√≥n Provincial del Agua</strong><br>
    Direcci√≥n de Usos Productivos del Agua<br>
    <em>Red de Canales de la Provincia del Chaco</em>
  </div>

  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 1. Inicializar mapa
    const map = L.map('map').setView([-27.45, -58.99], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution:'&copy; OpenStreetMap contributors', maxZoom:19
    }).addTo(map);

    // 2. Bot√≥n ‚ÄúCentrar vista‚Äù
    const CenterControl = L.Control.extend({
      onAdd: () => {
        const btn = L.DomUtil.create('button','center-button');
        btn.title='Centrar en la red'; btn.innerHTML='üîÑ';
        L.DomEvent.on(btn,'click',()=>{
          const fg=L.featureGroup([troncalLayer,principalLayer,secundarioLayer]);
          map.fitBounds(fg.getBounds(),{padding:[20,20]});
        });
        return btn;
      }
    });
    map.addControl(new CenterControl({position:'topright'}));

    // 3. Estilos y hover/popup
    function estiloBase(cat){
      if(cat==='TRONCAL')    return {color:'#000080',weight:4,opacity:0.8};
      if(cat==='PRINCIPAL')  return {color:'#00bfff',weight:3,opacity:0.8};
      if(cat==='SECUNDARIO') return {color:'#A52A2A',weight:2,opacity:0.8};
      return {color:'#888888',weight:2,opacity:0.6};
    }
    function onEach(f,l){
      const p=f.properties, keys=['NOMBRE','LONGITUD','ESTADO'];
      const pri=keys.filter(k=>p[k]!=null).map(k=>`<b>${k}:</b> ${p[k]}`);
      const resto=Object.keys(p).filter(k=>!keys.includes(k))
                 .map(k=>`<b>${k}:</b> ${p[k]}`);
      l.bindPopup(pri.concat(['<hr>']).concat(resto).join('<br>'));
      l.on('mouseover',()=>{
        const s=estiloBase((p.CATEGORIA||'').toUpperCase());
        l.setStyle({color:s.color,weight:s.weight+2,opacity:1});
        l.bringToFront();
      });
      l.on('mouseout',()=>l.setStyle(estiloBase((p.CATEGORIA||'').toUpperCase())));
    }

    // 4. Cargar GeoJSON y crear capas
    let troncalLayer, principalLayer, secundarioLayer;
    fetch('./red_canales_total.geojson').then(r=>r.json()).then(data=>{
      troncalLayer = L.geoJSON(data,{
        filter:f=>(f.properties.CATEGORIA||'').toUpperCase()==='TRONCAL',
        style:()=>estiloBase('TRONCAL'), onEachFeature:onEach
      }).addTo(map);

      principalLayer = L.geoJSON(data,{
        filter:f=>(f.properties.CATEGORIA||'').toUpperCase()==='PRINCIPAL',
        style:()=>estiloBase('PRINCIPAL'), onEachFeature:onEach
      }).addTo(map);

      secundarioLayer = L.geoJSON(data,{
        filter:f=>(f.properties.CATEGORIA||'').toUpperCase()==='SECUNDARIO',
        style:()=>estiloBase('SECUNDARIO'), onEachFeature:onEach
      }).addTo(map);

      // 5. Control de Capas + Leyenda, POSICI√ìN bottomright
      L.control.layers(null, {
        '<span><i style="background:#000080"></i> Troncal</span>': troncalLayer,
        '<span><i style="background:#00bfff"></i> Principal</span>': principalLayer,
        '<span><i style="background:#A52A2A"></i> Secundario</span>': secundarioLayer
      }, {
        collapsed: false,
        position: 'bottomright'
      }).addTo(map);
    }).catch(e=>console.error(e));
  </script>
</body>
</html>
